<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mentech | Plateforme Officielle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { --bg: #0f172a; --blue: #3b82f6; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg); color: white; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .locked #app-content { filter: blur(8px); pointer-events: none; }
        /* Animations */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .tech-card:hover { transform: translateY(-5px); border-color: var(--blue); }
    </style>
</head>
<body class="antialiased locked">

    <div id="login-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90">
        <div class="glass p-8 rounded-2xl max-w-sm w-full text-center">
            <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto mb-4 flex items-center justify-center text-2xl"><i class="fas fa-fingerprint"></i></div>
            <h2 class="text-2xl font-bold mb-2">Identification</h2>
            <input type="text" id="username" placeholder="Votre Nom (ex: Yassine)" class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white mb-4 text-center">
            <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold transition">Connexion</button>
        </div>
    </div>

    <div id="app-content">
        <nav class="fixed w-full z-40 glass top-0 border-b border-white/5">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                <div class="text-xl font-bold tracking-tighter">MEN<span class="text-blue-500">TECH</span></div>
                <div class="flex items-center gap-4">
                    <button onclick="openRecruitment()" class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-md transition">Devenir Technicien</button>
                    <div class="text-right hidden md:block">
                        <div class="text-[10px] text-gray-400">CONNECTÉ</div>
                        <div id="user-display" class="text-sm font-bold text-blue-400">...</div>
                    </div>
                </div>
            </div>
        </nav>

        <section class="pt-32 pb-12 px-6 text-center">
            <h1 class="text-5xl font-extrabold mb-6">Maintenance <span class="text-blue-500">Intelligente</span></h1>
            
            <div class="glass p-2 rounded-xl max-w-xl mx-auto flex gap-2">
                <div class="flex-1 bg-white/5 rounded-lg flex items-center px-4">
                    <i class="fas fa-map-marker-alt text-red-500 mr-2"></i>
                    <input type="text" id="location" placeholder="Votre Ville (ex: Rabat)" class="bg-transparent w-full outline-none text-sm py-3">
                </div>
                <button onclick="scrollToServices()" class="bg-blue-600 px-6 rounded-lg font-bold hover:bg-blue-500">Trouver</button>
            </div>
        </section>

        <section id="services" class="py-10 px-6 max-w-6xl mx-auto">
            <h2 class="text-lg font-bold mb-6 text-gray-400">// SERVICES DISPONIBLES</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="services-grid">
                </div>
        </section>

        <section id="results" class="py-10 px-6 max-w-6xl mx-auto hidden">
            <h2 class="text-2xl font-bold mb-6">Techniciens à <span id="res-loc" class="text-blue-400"></span></h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="tech-grid"></div>
        </section>
    </div>

    <div class="fixed bottom-6 right-6 z-50">
        <button onclick="toggleChat()" class="w-14 h-14 bg-blue-600 rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-110 transition"><i class="fas fa-headset"></i></button>
        
        <div id="chat-window" class="hidden absolute bottom-20 right-0 w-80 h-96 glass rounded-2xl flex flex-col overflow-hidden border border-white/20 shadow-2xl bg-[#0f172a]">
            <div class="bg-blue-600 p-4 font-bold flex justify-between">
                <span>Support Mentech</span>
                <span class="text-xs bg-white/20 px-2 py-0.5 rounded-full">En Ligne</span>
            </div>
            <div id="chat-msgs" class="flex-1 p-4 overflow-y-auto space-y-3 text-sm">
                <div class="bg-white/10 p-3 rounded-lg rounded-tl-none max-w-[85%]">
                    Bonjour ! Je suis Majda. Comment puis-je vous aider ?
                </div>
            </div>
            <div class="p-3 bg-white/5 flex gap-2">
                <input type="text" id="chat-input" placeholder="Message..." class="flex-1 bg-transparent outline-none text-sm" onkeypress="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()" class="text-blue-400"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const API_URL = "http://localhost:3000"; // Pointing to your local Node server
        let currentUser = "";
        
        // DATA
        const services = [
            { id: 'elec', name: 'Électronique', icon: 'fa-microchip', priceType: 'unknown' }, // Unknown Price
            { id: 'plomb', name: 'Plomberie', icon: 'fa-faucet', priceType: 'fixed', avg: 150 },
            { id: 'sat', name: 'Parabole', icon: 'fa-satellite-dish', priceType: 'fixed', avg: 100 },
            { id: 'froid', name: 'Froid', icon: 'fa-snowflake', priceType: 'unknown' }
        ];

        // 1. LOGIN
        function login() {
            const val = document.getElementById('username').value;
            if(val) {
                currentUser = val;
                document.getElementById('user-display').textContent = val;
                document.getElementById('login-overlay').style.display = 'none';
                document.body.classList.remove('locked');
            }
        }

        // 2. INIT
        document.addEventListener('DOMContentLoaded', () => {
            const grid = document.getElementById('services-grid');
            services.forEach(s => {
                const div = document.createElement('div');
                div.className = "glass p-6 rounded-xl text-center hover:bg-white/5 cursor-pointer transition border border-white/5";
                div.onclick = () => showTechs(s);
                div.innerHTML = `
                    <div class="text-3xl text-blue-400 mb-3"><i class="fas ${s.icon}"></i></div>
                    <div class="font-bold">${s.name}</div>
                    <div class="text-xs text-gray-400 mt-1">${s.priceType === 'unknown' ? 'Sur Devis' : 'À partir de ' + s.avg + ' DH'}</div>
                `;
                grid.appendChild(div);
            });
            
            // Poll for Support Replies
            setInterval(checkSupportReply, 3000);
        });

        function scrollToServices() { document.getElementById('services').scrollIntoView({behavior:'smooth'}); }

        // 3. SHOW TECHS
        function showTechs(service) {
            const loc = document.getElementById('location').value || "Casa";
            document.getElementById('res-loc').textContent = loc;
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('results').scrollIntoView({behavior:'smooth'});
            
            const grid = document.getElementById('tech-grid');
            grid.innerHTML = '';
            
            // Generate Fake Techs
            const techs = ["Ahmed", "Karim", "Yassine"];
            techs.forEach(name => {
                const card = document.createElement('div');
                card.className = "glass p-5 rounded-xl border border-white/10 tech-card";
                
                // PRICE DISPLAY LOGIC
                let priceDisplay = "";
                if(service.priceType === 'unknown') {
                    priceDisplay = `<span class="text-yellow-400 font-bold">Prix à négocier</span>`;
                } else {
                    priceDisplay = `<span class="text-white font-bold">${service.avg} DH</span>`;
                }

                card.innerHTML = `
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center font-bold">${name[0]}</div>
                        <div>
                            <div class="font-bold">${name}</div>
                            <div class="text-xs text-green-400">● Disponible</div>
                        </div>
                    </div>
                    <div class="bg-white/5 p-2 rounded mb-4 text-sm flex justify-between">
                        <span>Tarif:</span> ${priceDisplay}
                    </div>
                    <button onclick="startMission('${name}', '${service.name}', '${service.priceType}')" class="w-full bg-blue-600 py-2 rounded font-bold hover:bg-blue-500">Engager</button>
                `;
                grid.appendChild(card);
            });
        }

        // 4. MISSION FLOW (The "Negotiation & Declaration")
        function startMission(techName, serviceName, priceType) {
            let msg = "";
            if(priceType === 'unknown') {
                msg = `Vous avez choisi ${techName}. Le prix sera fixé sur place après diagnostic.`;
            } else {
                msg = `Technicien en route. Prix estimé affiché.`;
            }

            Swal.fire({
                title: 'Technicien Confirmé',
                text: msg,
                icon: 'success',
                confirmButtonText: 'Mission Terminée (Simulation)',
                confirmButtonColor: '#10b981',
                background: '#0f172a', color: '#fff'
            }).then((result) => {
                if(result.isConfirmed) {
                    declarePayment(techName, serviceName);
                }
            });
        }

        // 5. PAYMENT DECLARATION (Client Side)
        function declarePayment(techName, mission) {
            Swal.fire({
                title: 'Clôture de Mission',
                text: `Combien avez-vous payé à ${techName} ?`,
                input: 'number',
                inputPlaceholder: 'Montant en DH',
                background: '#0f172a', color: '#fff',
                showCancelButton: true,
                confirmButtonText: 'Valider',
                preConfirm: (amount) => {
                    if (!amount) Swal.showValidationMessage('Montant requis');
                    return amount;
                }
            }).then((result) => {
                if(result.isConfirmed) {
                    const clientPaid = result.value;
                    
                    // SIMULATE TECH DECLARATION (Normally this comes from the Tech App)
                    // For demo, we simulate the tech enters the SAME amount (Success) or DIFFERENT (Conflict)
                    // Let's assume Success for the demo:
                    const techReceived = clientPaid; 

                    // SEND TO SERVER
                    fetch(`${API_URL}/api/mission/declare`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            clientName: currentUser,
                            techName: techName,
                            clientPaid: clientPaid,
                            techReceived: techReceived, // Simulated
                            mission: mission
                        })
                    }).then(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Paiement Validé',
                            text: 'Les montants correspondent. Mission archivée.',
                            background: '#0f172a', color: '#fff'
                        });
                    });
                }
            });
        }

        // 6. RECRUITMENT FORM
        function openRecruitment() {
            Swal.fire({
                title: 'Devenir Technicien',
                html: `
                    <input id="rec-name" class="swal2-input" placeholder="Nom Complet">
                    <input id="rec-phone" class="swal2-input" placeholder="Téléphone">
                    <input id="rec-spec" class="swal2-input" placeholder="Spécialité">
                `,
                background: '#0f172a', color: '#fff',
                confirmButtonText: 'Postuler',
                preConfirm: () => {
                    return [
                        document.getElementById('rec-name').value,
                        document.getElementById('rec-phone').value,
                        document.getElementById('rec-spec').value
                    ]
                }
            }).then((result) => {
                if(result.isConfirmed) {
                    const [name, phone, spec] = result.value;
                    fetch(`${API_URL}/api/recruit`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ name, phone, specialty: spec })
                    });
                    Swal.fire('Envoyé!', 'Votre candidature est en cours de traitement.', 'success');
                }
            });
        }

        // 7. SUPPORT CHAT FUNCTIONS
        function toggleChat() {
            document.getElementById('chat-window').classList.toggle('hidden');
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value;
            if(!msg) return;

            // Add to UI
            const div = document.createElement('div');
            div.className = "bg-blue-600 p-3 rounded-lg rounded-tr-none ml-auto max-w-[85%] text-white";
            div.textContent = msg;
            document.getElementById('chat-msgs').appendChild(div);
            
            // Send to Server
            fetch(`${API_URL}/api/support/send`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user: currentUser || "Visiteur", message: msg })
            });

            input.value = "";
            document.getElementById('chat-msgs').scrollTop = document.getElementById('chat-msgs').scrollHeight;
        }

        async function checkSupportReply() {
            try {
                const res = await fetch(`${API_URL}/api/support/poll`);
                const data = await res.json();
                if(data.reply) {
                    const div = document.createElement('div');
                    div.className = "bg-white/10 p-3 rounded-lg rounded-tl-none max-w-[85%]";
                    div.innerHTML = `<span class="text-xs text-blue-400 block mb-1">Majda</span> ${data.reply}`;
                    document.getElementById('chat-msgs').appendChild(div);
                    document.getElementById('chat-msgs').scrollTop = document.getElementById('chat-msgs').scrollHeight;
                }
            } catch(e) { console.log("Server offline?"); }
        }
    </script>
</body>
</html>
