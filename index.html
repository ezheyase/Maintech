<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MenTech - Maintenance Pro</title>
    <link rel="image\png" href="radius.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary: #6366f1; --accent: #f43f5e; --dark: #0f172a; --success: #10b981; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--dark); color: white; min-height: 100vh; overflow-x: hidden; }
        
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-hover:hover { background: rgba(255, 255, 255, 0.1); transform: translateY(-5px); border-color: var(--primary); }
        
        .view { display: none; animation: fadeIn 0.4s ease-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .loader { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .msg { max-width: 80%; padding: 10px 15px; border-radius: 12px; margin-bottom: 10px; font-size: 14px; position: relative; }
        .msg.sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg.received { align-self: flex-start; background: rgba(255,255,255,0.1); color: white; border-bottom-left-radius: 2px; border: 1px solid rgba(255,255,255,0.1); }
        .chat-area { display: flex; flex-direction: column; height: 60vh; overflow-y: auto; padding: 20px; }
    </style>
</head>
<body class="antialiased">

    <nav class="fixed w-full z-40 glass top-0 hidden" id="main-nav">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-extrabold tracking-tighter cursor-pointer" onclick="location.reload()">
                MEN<span class="text-indigo-500">TECH</span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="switchView('recruitment')" class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-md transition border border-white/10 hidden sm:block" id="btn-recruit-nav">Devenir Technicien</button>
                
                <div class="text-right">
                    <div class="text-[10px] text-emerald-400 font-mono tracking-widest uppercase">‚óè <span id="role-badge">Client</span></div>
                    <div class="text-sm font-bold text-gray-300" id="nav-user-name">...</div>
                </div>
                <button onclick="location.reload()" class="w-10 h-10 rounded-full bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white transition flex items-center justify-center">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <div id="address-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="glass p-8 rounded-3xl max-w-md w-full border-indigo-500/30">
            <h3 class="text-2xl font-bold mb-2">D√©tails de l'intervention</h3>
            <p class="text-gray-400 mb-6 text-sm">O√π le technicien doit-il se rendre ?</p>
            <label class="block text-sm font-bold mb-2">Adresse exacte *</label>
            <input type="text" id="client-address" placeholder="Ex: 12 Rue Hassan II, Appt 4" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-indigo-500 mb-4">
            <label class="block text-sm font-bold mb-2">Note (Optionnel)</label>
            <textarea id="client-notes" rows="2" placeholder="Ex: Code porte 1234, ascenseur en panne..." class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-indigo-500 mb-6"></textarea>
            <div class="flex gap-3">
                <button onclick="document.getElementById('address-modal').classList.add('hidden')" class="flex-1 bg-white/10 hover:bg-white/20 py-3 rounded-xl font-bold transition">Annuler</button>
                <button onclick="confirmMissionRequest()" class="flex-1 bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl font-bold transition">Confirmer</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6 pt-24 pb-20">
        
        <div id="view-login" class="view active flex items-center justify-center min-h-[80vh]">
            <div class="glass p-8 rounded-3xl max-w-md w-full text-center border-indigo-500/30 shadow-2xl shadow-indigo-500/10">
                <div class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center text-4xl mx-auto mb-6 shadow-lg"><i class="fas fa-fingerprint"></i></div>
                <h2 class="text-3xl font-bold mb-2">Identification</h2>
                <p class="text-gray-400 mb-8">Choisissez votre profil pour la d√©mo</p>
                <input type="text" id="login-name" placeholder="Votre Pr√©nom" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-indigo-500 transition mb-4 text-center">
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="login('client')" class="bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2"><i class="fas fa-user"></i> Client</button>
                    <button onclick="login('tech')" class="bg-emerald-600 hover:bg-emerald-500 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2"><i class="fas fa-toolbox"></i> Tech</button>
                </div>
            </div>
        </div><div id="view-home" class="view pt-10">
            <div class="text-center mb-16">
                <h1 class="text-5xl md:text-6xl font-extrabold mb-4">R√©paration <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-rose-400">Imm√©diate</span></h1>
                <p class="text-gray-400 text-lg mb-8">S√©lectionnez le domaine d'intervention.</p>
                <div class="glass max-w-2xl mx-auto flex items-center p-2 rounded-full mb-10">
                    <input type="text" id="search-input" placeholder="Que recherchez-vous ?" class="flex-1 bg-transparent border-none outline-none text-white px-4">
                    <button onclick="searchProblem()" class="bg-indigo-600 hover:bg-indigo-500 px-6 py-2 rounded-full font-bold transition"><i class="fas fa-search"></i> Chercher</button>
                </div>
                <div class="flex justify-center gap-8 text-sm font-bold text-gray-300">
                    <div><span class="text-indigo-400 text-2xl block">500+</span> Techniciens</div>
                    <div><span class="text-emerald-400 text-2xl block">24/7</span> Support</div>
                    <div><span class="text-rose-400 text-2xl block">98%</span> Satisfaction</div>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="categories-grid"></div>
        </div>

        <div id="view-devices" class="view pt-10">
            <button onclick="switchView('home')" class="mb-6 text-gray-400 hover:text-white transition flex items-center gap-2"><i class="fas fa-arrow-left"></i> Retour</button>
            <div class="mb-8"><h2 class="text-3xl font-bold" id="selected-category-title">Cat√©gorie</h2></div>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="devices-grid"></div>
        </div>

        <div id="view-problems" class="view pt-10">
            <button onclick="switchView('devices')" class="mb-6 text-gray-400 hover:text-white transition flex items-center gap-2"><i class="fas fa-arrow-left"></i> Retour</button>
            <div class="mb-8 flex items-center gap-4">
                <div class="w-16 h-16 rounded-xl glass flex items-center justify-center text-3xl text-indigo-400" id="selected-device-icon"></div>
                <div><h2 class="text-3xl font-bold" id="selected-device-title">Appareil</h2><p class="text-gray-400">Pr√©cisez le dysfonctionnement.</p></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="problems-grid"></div>
            <div class="mt-8 glass p-6 rounded-2xl">
                <label class="block text-sm font-bold text-gray-300 mb-2">Autre probl√®me (Description libre)</label>
                <div class="flex gap-2">
                    <input type="text" id="custom-problem-input" placeholder="D√©crivez votre probl√®me ici..." class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-indigo-500 transition">
                    <button onclick="selectProblem('custom')" class="bg-indigo-600 hover:bg-indigo-500 px-6 py-3 rounded-xl font-bold transition">Valider</button>
                </div>
            </div>
        </div>

        <div id="view-technicians" class="view pt-10">
            <button onclick="switchView('problems')" class="mb-6 text-gray-400 hover:text-white transition flex items-center gap-2"><i class="fas fa-arrow-left"></i> Retour</button>
            <div class="mb-8"><h2 class="text-3xl font-bold">Techniciens Disponibles</h2><p class="text-emerald-400">Experts certifi√©s pr√™ts √† intervenir.</p></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="techs-list-grid"></div>
        </div>

        <div id="view-recruitment" class="view pt-10">
            <button onclick="switchView(currentUser.role === 'client' ? 'home' : 'login')" class="mb-6 text-gray-400 hover:text-white transition flex items-center gap-2"><i class="fas fa-arrow-left"></i> Retour</button>
            <div class="glass max-w-xl mx-auto p-8 rounded-3xl border-indigo-500/30 shadow-2xl">
                <h2 class="text-3xl font-bold mb-6 text-center">Rejoindre MenTech</h2>
                <div class="space-y-4">
                    <div><label class="block text-sm font-bold mb-2">Nom complet</label><input type="text" id="recruit-name" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-indigo-500"></div>
                    <div><label class="block text-sm font-bold mb-2">T√©l√©phone</label><input type="text" id="recruit-phone" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-indigo-500"></div>
                    <div><label class="block text-sm font-bold mb-2">Sp√©cialit√©</label>
                        <select id="recruit-specialty" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-indigo-500 appearance-none">
                            <option value="Plomberie" class="bg-gray-800">Plomberie</option>
                            <option value="√âlectricit√©" class="bg-gray-800">√âlectricit√©</option>
                            <option value="√âlectrom√©nager" class="bg-gray-800">√âlectrom√©nager</option>
                            <option value="Informatique" class="bg-gray-800">Informatique</option>
                        </select>
                    </div>
                    <button onclick="submitRecruitment()" class="w-full bg-indigo-600 hover:bg-indigo-500 py-4 rounded-xl font-bold transition mt-4">Envoyer ma candidature</button>
                </div>
            </div>
        </div>

        <div id="view-waiting" class="view pt-20 text-center">
            <div class="glass max-w-md mx-auto p-10 rounded-3xl border-indigo-500/30">
                <div class="loader mb-8"></div>
                <h2 class="text-2xl font-bold mb-2">Demande Envoy√©e</h2>
                <p class="text-gray-400 mb-6">En attente de la confirmation de <strong id="wait-tech-name" class="text-white">...</strong></p>
                <div class="w-full bg-white/10 rounded-full h-2 mb-2 overflow-hidden"><div class="bg-indigo-500 h-2 rounded-full w-full origin-left animate-[shrink_30s_linear_forwards]"></div></div>
            </div>
        </div>

        <div id="view-tech-dashboard" class="view pt-10">
            <div class="flex items-center justify-between mb-8">
                <div><h2 class="text-3xl font-bold">Espace Technicien</h2><p class="text-gray-400">Missions en attente de r√©ponse</p></div>
                <div class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse shadow-[0_0_10px_#10b981]"></div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="glass p-4 rounded-xl text-center"><div class="text-2xl font-bold text-indigo-400" id="stat-pending">0</div><div class="text-xs text-gray-400">En attente</div></div>
                <div class="glass p-4 rounded-xl text-center"><div class="text-2xl font-bold text-emerald-400" id="stat-completed">0</div><div class="text-xs text-gray-400">Termin√©es</div></div>
                <div class="glass p-4 rounded-xl text-center"><div class="text-2xl font-bold text-rose-400" id="stat-declined">0</div><div class="text-xs text-gray-400">Refus√©es</div></div>
                <div class="glass p-4 rounded-xl text-center"><div class="text-2xl font-bold text-yellow-400"><span id="stat-earned">0</span> DH</div><div class="text-xs text-gray-400">Gagn√©s</div></div>
            </div>
            <div id="incoming-missions-container" class="space-y-4"></div>
            <h3 class="text-xl font-bold mt-12 mb-4">Historique</h3>
            <div id="completed-missions-container" class="space-y-4 opacity-70"></div>
        </div>

        <div id="view-chat" class="view pt-4">
            <div class="glass max-w-2xl mx-auto rounded-3xl overflow-hidden border-indigo-500/30 flex flex-col h-[75vh]">
                <div class="bg-indigo-600/20 p-4 border-b border-white/10 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center font-bold"><i class="fas fa-comment-dots"></i></div>
                        <div>
                            <h3 class="font-bold" id="chat-title">Intervention en cours</h3>
                            <p class="text-xs text-emerald-400">Le technicien est en route</p>
                        </div>
                    </div>
                    <button onclick="endMission()" class="bg-rose-600 hover:bg-rose-500 px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2">
                        <i class="fas fa-flag-checkered"></i> Terminer
                    </button>
                </div>
                <div class="chat-area flex-1" id="chat-messages-box"></div>
                <div class="p-4 bg-white/5 border-t border-white/10 flex gap-2">
                    <input type="text" id="chat-input" placeholder="√âcrivez votre message..." class="flex-1 bg-black/20 border border-white/10 rounded-xl px-4 text-white outline-none focus:border-indigo-500" onkeypress="if(event.key === 'Enter') sendChatMessage()">
                    <button onclick="sendChatMessage()" class="bg-indigo-600 hover:bg-indigo-500 w-12 h-12 rounded-xl flex items-center justify-center transition"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

    </div> <div class="fixed bottom-6 right-6 z-50">
        <button onclick="toggleSupport()" class="w-16 h-16 bg-[#25D366] rounded-full shadow-lg shadow-[#25D366]/40 flex items-center justify-center text-3xl hover:scale-110 transition">
            <i class="fab fa-whatsapp text-white"></i>
        </button>
    </div>

    <div id="support-modal" class="fixed bottom-28 right-6 w-80 bg-white rounded-2xl overflow-hidden shadow-2xl z-50 hidden flex-col">
        <div class="bg-[#075e54] p-4 text-white flex items-center gap-3">
            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center font-bold">M</div>
            <div class="flex-1">
                <h4 class="font-bold leading-tight">Majda (Support)</h4>
                <p class="text-[10px] text-green-200">R√©pond g√©n√©ralement en 2 min</p>
            </div>
            <button onclick="toggleSupport()" class="text-white/70 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <div class="h-64 bg-[#e5ddd5] p-4 overflow-y-auto flex flex-col gap-2" id="support-messages">
            <div class="self-start bg-white text-black p-2 rounded-lg text-sm max-w-[85%] shadow-sm rounded-tl-none">
                Salam! Comment puis-je vous aider aujourd'hui?
            </div>
        </div>
        <div class="p-2 bg-[#f0f0f0] flex gap-2">
            <input type="text" id="support-input" placeholder="√âcrire un message..." class="flex-1 rounded-full px-4 py-2 border-none outline-none text-black text-sm" onkeypress="if(event.key === 'Enter') sendSupportMessage()">
            <button onclick="sendSupportMessage()" class="w-10 h-10 bg-[#075e54] text-white rounded-full flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="toast" class="fixed top-6 right-6 bg-indigo-600 text-white px-6 py-3 rounded-xl shadow-lg transform translate-x-full transition-transform duration-300 z-[9999] font-bold">
        Message
    </div>
    <script>
        // ==========================================
        // 1. CONFIGURATION (FIREBASE & WEBHOOKS)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCvyRWcn7UInVxpLjHsuhEmzkunP-jJ7H0",
            authDomain: "mentech-chat.firebaseapp.com",
            databaseURL: "https://mentech-chat-default-rtdb.firebaseio.com",
            projectId: "mentech-chat",
            storageBucket: "mentech-chat.firebasestorage.app",
            messagingSenderId: "58331382384",
            appId: "1:58331382384:web:f129da8c07b0f06ce76ab5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Tes Webhooks Discord
        const DISCORD_MISSION_WEBHOOK = 'https://discord.com/api/webhooks/1473811156626837617/N1_ynWzRTcgErVHaV2OiOq8bWmAnLtU8FDOqAYOia621T6u-XhIrfBJgHE6t4EPzbDhC';
        const DISCORD_RECRUIT_WEBHOOK = 'https://discord.com/api/webhooks/1473825828700946555/TU29M7GsUXb24Hn8nphfviURKa3uHdt6KA5JyVWvzkLvj83Moy7UdZWR0-GXE1O-fIYj';

        // ==========================================
        // 2. DONN√âES & √âTAT (STATE)
        // ==========================================
        let currentUser = { name: "", role: "" };
        let currentState = { category: null, device: null, problem: null, missionId: null, techName: null, address: "", notes: "" };

        const DATA = {
            electromenager: {
                title: "√âlectrom√©nager", icon: "fa-blender", color: "text-blue-400",
                devices: {
                    refrigerateur: { title: "R√©frig√©rateur", icon: "fa-temperature-low", problems: ["Ne refroidit plus", "Fait trop de givre", "Bruit anormal"] },
                    lave_linge: { title: "Lave-linge", icon: "fa-water", problems: ["Ne se vide pas", "Le tambour ne tourne pas", "Fuit par le bas"] }
                }
            },
            informatique: {
                title: "Informatique", icon: "fa-laptop-code", color: "text-purple-400",
                devices: {
                    ordinateur: { title: "PC / Ordinateur", icon: "fa-laptop", problems: ["√âcran noir", "Tr√®s lent / Virus", "Batterie HS"] }
                }
            },
            plomberie: {
                title: "Plomberie", icon: "fa-faucet-drip", color: "text-cyan-400",
                devices: {
                    chauffe_eau: { title: "Chauffe-eau", icon: "fa-hot-tub-person", problems: ["Plus d'eau chaude", "Fuite par le bas", "Fait disjoncter"] },
                    robinetterie: { title: "Robinets", icon: "fa-sink", problems: ["Robinet qui goutte", "√âvier bouch√©", "Remplacement"] }
                }
            }
        };

        const TECHNICIANS = [
            { id: "t1", name: "Hassan", category: "plomberie", rating: "4.9", price: "150 DH/h" },
            { id: "t2", name: "Yassine", category: "informatique", rating: "5.0", price: "Sur Devis" },
            { id: "t3", name: "Omar", category: "electromenager", rating: "4.8", price: "120 DH/h" }
        ];

        // ==========================================
        // 3. UTILITAIRES & NAVIGATION
        // ==========================================
        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `fixed top-6 right-6 px-6 py-3 rounded-xl shadow-lg transform transition-transform duration-300 z-[9999] font-bold ${isError ? 'bg-rose-500' : 'bg-emerald-500'} text-white translate-x-0`;
            setTimeout(() => { toast.classList.replace('translate-x-0', 'translate-x-[200%]'); }, 3000);
        }

        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            window.scrollTo(0,0);
        }

        function login(role) {
            const name = document.getElementById('login-name').value.trim();
            if(!name) return Swal.fire({icon: 'error', title: 'Erreur', text: 'Entrez un pr√©nom', background: '#0f172a', color: '#fff'});
            
            currentUser = { name: name, role: role };
            document.getElementById('nav-user-name').textContent = name;
            document.getElementById('role-badge').textContent = role === 'tech' ? 'Technicien' : 'Client';
            document.getElementById('main-nav').classList.remove('hidden');

            if(role === 'client') {
                document.getElementById('btn-recruit-nav').classList.remove('hidden');
                renderCategories();
                switchView('home');
            } else {
                switchView('tech-dashboard');
                listenForTechMissions(); 
            }
        }

        // ==========================================
        // 4. PARCOURS CLIENT
        // ==========================================
        function renderCategories() {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = Object.keys(DATA).map(catKey => `
                <div class="glass glass-hover p-6 rounded-2xl text-center cursor-pointer transition duration-300" onclick="selectCategory('${catKey}')">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-white/5 flex items-center justify-center text-3xl ${DATA[catKey].color}"><i class="fas ${DATA[catKey].icon}"></i></div>
                    <h3 class="font-bold text-lg">${DATA[catKey].title}</h3>
                </div>`).join('');
        }

        function selectCategory(catKey) {
            currentState.category = catKey;
            document.getElementById('selected-category-title').textContent = DATA[catKey].title;
            const grid = document.getElementById('devices-grid');
            grid.innerHTML = Object.keys(DATA[catKey].devices).map(devKey => `
                <div class="glass glass-hover p-5 rounded-xl cursor-pointer flex items-center gap-4 transition duration-300" onclick="selectDevice('${devKey}')">
                    <div class="w-12 h-12 rounded-lg bg-white/5 flex items-center justify-center text-2xl text-gray-300"><i class="fas ${DATA[catKey].devices[devKey].icon}"></i></div>
                    <h4 class="font-bold">${DATA[catKey].devices[devKey].title}</h4>
                </div>`).join('');
            switchView('devices');
        }

        function selectDevice(devKey) {
            currentState.device = devKey;
            const dev = DATA[currentState.category].devices[devKey];
            document.getElementById('selected-device-title').textContent = dev.title;
            document.getElementById('selected-device-icon').innerHTML = `<i class="fas ${dev.icon}"></i>`;
            const grid = document.getElementById('problems-grid');
            grid.innerHTML = dev.problems.map((prob) => `
                <div class="glass glass-hover p-4 rounded-xl cursor-pointer flex justify-between items-center transition duration-300" onclick="selectProblem('${prob}')">
                    <span class="font-semibold text-gray-200">${prob}</span><i class="fas fa-chevron-right text-indigo-500 opacity-50"></i>
                </div>`).join('');
            switchView('problems');
        }

        function selectProblem(problem) {
            if(problem === 'custom') {
                problem = document.getElementById('custom-problem-input').value.trim();
                if(!problem) return showToast("Veuillez d√©crire le probl√®me", true);
            }
            currentState.problem = problem;
            const filteredTechs = TECHNICIANS.filter(t => t.category === currentState.category);
            const grid = document.getElementById('techs-list-grid');
            
            if(filteredTechs.length === 0) {
                grid.innerHTML = `<p class="col-span-full text-center text-gray-400 py-10">Aucun technicien disponible dans cette cat√©gorie pour le moment.</p>`;
            } else {
                grid.innerHTML = filteredTechs.map(t => `
                    <div class="glass p-5 rounded-2xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-emerald-500/20 text-emerald-400 text-[10px] px-3 py-1 font-bold rounded-bl-lg border-b border-l border-emerald-500/30">DISPO</div>
                        <div class="flex items-center gap-4 mb-4 mt-2">
                            <div class="w-14 h-14 bg-gradient-to-br from-gray-700 to-gray-900 rounded-full flex items-center justify-center text-xl font-bold border border-white/10">${t.name.charAt(0)}</div>
                            <div><h4 class="font-bold text-lg">${t.name}</h4><div class="text-xs text-yellow-400"><i class="fas fa-star"></i> ${t.rating}</div></div>
                        </div>
                        <div class="text-sm text-gray-400 mb-4"><i class="fas fa-wallet w-5"></i> Tarif: <span class="text-white font-semibold">${t.price}</span></div>
                        <button onclick="openAddressModal('${t.name}')" class="w-full bg-white text-black font-bold py-2 rounded-xl hover:bg-gray-200 transition">Engager</button>
                    </div>`).join('');
            }
            switchView('technicians');
        }

        // ==========================================
        // 5. CR√âATION MISSION & FIREBASE PUSH
        // ==========================================
        function openAddressModal(techName) {
            currentState.techName = techName;
            document.getElementById('address-modal').classList.remove('hidden');
        }

        function confirmMissionRequest() {
            const address = document.getElementById('client-address').value.trim();
            const notes = document.getElementById('client-notes').value.trim();
            if(!address) return showToast("L'adresse est obligatoire", true);

            currentState.address = address;
            currentState.notes = notes;
            currentState.missionId = "MT-" + Date.now();
            document.getElementById('address-modal').classList.add('hidden');

            const missionData = {
                id: currentState.missionId,
                client: currentUser.name,
                tech: currentState.techName,
                service: DATA[currentState.category].title,
                device: DATA[currentState.category].devices[currentState.device].title,
                problem: currentState.problem,
                address: currentState.address,
                notes: currentState.notes,
                status: "pending",
                timestamp: Date.now()
            };

            // Envoi Firebase
            db.ref('missions/' + currentState.missionId).set(missionData);
            
            // Envoi Webhook Discord (Nouvelle Mission)
            sendDiscordWebhook(DISCORD_MISSION_WEBHOOK, `üö® **NOUVELLE MISSION EN ATTENTE**\n**ID:** ${missionData.id}\n**Client:** ${missionData.client}\n**Technicien:** ${missionData.tech}\n**Probl√®me:** ${missionData.device} - ${missionData.problem}\n**Adresse:** ${missionData.address}`);

            document.getElementById('wait-tech-name').textContent = currentState.techName;
            switchView('waiting');

            // √âcouter la r√©ponse du Tech
            db.ref('missions/' + currentState.missionId + '/status').on('value', (snapshot) => {
                const status = snapshot.val();
                if(status === 'accepted') {
                    showToast(`${currentState.techName} est en route !`);
                    startChat();
                } else if(status === 'refused') {
                    Swal.fire({icon: 'error', title: 'Refus√©e', text: 'Le technicien est occup√©.', background: '#0f172a', color: '#fff'})
                    .then(() => switchView('technicians'));
                } else if(status === 'completed') {
                    triggerEndMissionFlow();
                }
            });
        }

        // ==========================================
        // 6. DASHBOARD TECHNICIEN
        // ==========================================
        function listenForTechMissions() {
            db.ref('missions').on('value', (snapshot) => {
                const missions = snapshot.val();
                if(!missions) return;

                let pendingHtml = '';
                let historyHtml = '';
                let pendingCount = 0, completedCount = 0, declinedCount = 0;

                Object.values(missions).reverse().forEach(m => {
                    if(m.tech === currentUser.name) {
                        if(m.status === 'pending') {
                            pendingCount++;
                            pendingHtml += `
                                <div class="glass p-5 rounded-2xl border-l-4 border-l-yellow-500">
                                    <div class="flex justify-between items-start mb-3"><h3 class="font-bold text-lg">Nouvelle Demande</h3><span class="text-xs text-yellow-400">${m.id}</span></div>
                                    <div class="text-sm text-gray-300 space-y-1 mb-4 bg-black/20 p-3 rounded-lg">
                                        <p><strong class="text-white">Client:</strong> ${m.client}</p>
                                        <p><strong class="text-white">Adresse:</strong> ${m.address}</p>
                                        <p><strong class="text-white">Probl√®me:</strong> <span class="text-rose-400">${m.device} - ${m.problem}</span></p>
                                        ${m.notes ? `<p><strong class="text-white">Notes:</strong> <i>"${m.notes}"</i></p>` : ''}
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="respondToMission('${m.id}', 'accepted')" class="flex-1 bg-emerald-600 hover:bg-emerald-500 py-2 rounded-xl font-bold transition">Accepter</button>
                                        <button onclick="respondToMission('${m.id}', 'refused')" class="flex-1 bg-rose-600 hover:bg-rose-500 py-2 rounded-xl font-bold transition">Refuser</button>
                                    </div>
                                </div>`;
                        } else {
                            if(m.status === 'completed') completedCount++;
                            if(m.status === 'refused') declinedCount++;
                            
                            let statusColor = m.status === 'completed' ? 'text-emerald-400' : 'text-rose-400';
                            let statusText = m.status === 'completed' ? 'Termin√©e' : (m.status === 'refused' ? 'Refus√©e' : 'Accept√©e');
                            
                            historyHtml += `
                                <div class="glass p-4 rounded-xl flex justify-between items-center">
                                    <div><p class="font-bold">${m.device}</p><p class="text-xs text-gray-400">Client: ${m.client}</p></div>
                                    <div class="${statusColor} font-bold text-sm">${statusText}</div>
                                </div>`;
                        }
                    }
                });

                document.getElementById('stat-pending').textContent = pendingCount;
                document.getElementById('stat-completed').textContent = completedCount;
                document.getElementById('stat-declined').textContent = declinedCount;

                document.getElementById('incoming-missions-container').innerHTML = pendingHtml !== '' ? pendingHtml : '<p class="text-gray-500 italic text-center py-6 glass rounded-xl">Aucune mission en attente.</p>';
                document.getElementById('completed-missions-container').innerHTML = historyHtml !== '' ? historyHtml : '<p class="text-gray-500 italic text-sm">Historique vide.</p>';
            });
        }

        function respondToMission(missionId, response) {
            db.ref('missions/' + missionId).update({ status: response });
            if(response === 'accepted') {
                currentState.missionId = missionId;
                startChat();
                // Tech √©coute aussi la compl√©tion
                db.ref('missions/' + missionId + '/status').on('value', (snap) => {
                    if(snap.val() === 'completed') triggerEndMissionFlow();
                });
            }
        }

        // ==========================================
        // 7. CHAT EN TEMPS R√âEL
        // ==========================================
        function startChat() {
            switchView('chat');
            const chatBox = document.getElementById('chat-messages-box');
            chatBox.innerHTML = ''; 

            db.ref('chats/' + currentState.missionId).on('child_added', (snapshot) => {
                const data = snapshot.val();
                const isMe = data.user === currentUser.name;
                const timeStr = new Date(data.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                
                const div = document.createElement('div');
                div.className = `msg flex flex-col ${isMe ? 'sent' : 'received'}`;
                div.innerHTML = `${!isMe ? `<span class="text-[10px] text-indigo-300 font-bold mb-1">${data.user}</span>` : ''}
                                 <span>${data.text}</span>
                                 <span class="text-[9px] opacity-70 text-right mt-1">${timeStr}</span>`;
                chatBox.appendChild(div);
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;
            db.ref('chats/' + currentState.missionId).push({ user: currentUser.name, text: text, timestamp: Date.now() });
            input.value = "";
        }

        // ==========================================
        // 8. SYST√àME DOUBLE PAIEMENT (LIAISON PARTIE 4)
        // ==========================================
        function endMission() {
            Swal.fire({
                title: 'Terminer la mission ?', text: "L'intervention est-elle termin√©e ?", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#10b981', cancelButtonColor: '#f43f5e',
                confirmButtonText: 'Oui, terminer', cancelButtonText: 'Annuler', background: '#0f172a', color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('missions/' + currentState.missionId).update({ status: 'completed' });
                }
            });
        }

        function triggerEndMissionFlow() {
            // Le prompt s'affiche chez le Client ET chez le Technicien
            Swal.fire({
                title: 'D√©claration de Paiement',
                text: currentUser.role === 'client' ? "Combien avez-vous pay√© le technicien (en DH) ?" : "Combien avez-vous re√ßu du client (en DH) ?",
                input: 'number',
                inputAttributes: { min: 0 },
                showCancelButton: false,
                confirmButtonColor: '#6366f1',
                confirmButtonText: 'Valider',
                background: '#0f172a', color: '#fff',
                allowOutsideClick: false
            }).then((result) => {
                if(result.isConfirmed) {
                    const declaredPrice = result.value;
                    const updateField = currentUser.role === 'client' ? { clientPrice: declaredPrice } : { techPrice: declaredPrice };
                    
                    db.ref('missions/' + currentState.missionId).update(updateField).then(() => {
                        showToast("Paiement enregistr√©.");
                        switchView(currentUser.role === 'client' ? 'home' : 'tech-dashboard');
                        checkPaymentConflict(currentState.missionId);
                    });
                }
            });
        }

        let paymentChecked = false; // Anti-boucle
        function checkPaymentConflict(missionId) {
            if(paymentChecked) return;
            
            db.ref('missions/' + missionId).on('value', (snapshot) => {
                const data = snapshot.val();
                // Si les DEUX ont d√©clar√© le prix
                if(data.clientPrice && data.techPrice && !paymentChecked) {
                    paymentChecked = true;
                    if(data.clientPrice === data.techPrice) {
                        // SUCCESS
                        sendDiscordWebhook(DISCORD_MISSION_WEBHOOK, `‚úÖ **MISSION CL√îTUR√âE AVEC SUCC√àS**\n**ID:** ${missionId}\n**Client:** ${data.client}\n**Technicien:** ${data.tech}\n**Prix pay√©:** ${data.clientPrice} DH`);
                    } else {
                        // CONFLIT
                        sendDiscordWebhook(DISCORD_MISSION_WEBHOOK, `üö® **CONFLIT DE PAIEMENT D√âTECT√â** üö®\n**ID:** ${missionId}\n**Client (${data.client}):** D√©clare avoir pay√© **${data.clientPrice} DH**\n**Technicien (${data.tech}):** D√©clare avoir re√ßu **${data.techPrice} DH**\n@everyone Intervention requise.`);
                    }
                }
            });
        }

        // ==========================================
        // 9. RECRUTEMENT & WEBHOOKS
        // ==========================================
        function submitRecruitment() {
            const name = document.getElementById('recruit-name').value.trim();
            const phone = document.getElementById('recruit-phone').value.trim();
            const spec = document.getElementById('recruit-specialty').value;
            
            if(!name || !phone) return showToast("Remplissez tous les champs", true);

            sendDiscordWebhook(DISCORD_RECRUIT_WEBHOOK, `üìÑ **NOUVELLE CANDIDATURE TECHNICIEN**\n**Nom:** ${name}\n**T√©l:** ${phone}\n**Sp√©cialit√©:** ${spec}`);
            
            Swal.fire({icon: 'success', title: 'Candidature envoy√©e', text: 'Notre √©quipe va vous contacter.', background: '#0f172a', color: '#fff'})
            .then(() => switchView('home'));
        }

        function sendDiscordWebhook(url, message) {
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: message })
            }).catch(e => console.error("Erreur Webhook", e));
        }

        // ==========================================
        // 10. SUPPORT CHAT (SIMULATION MAJDA)
        // ==========================================
        function toggleSupport() {
            const modal = document.getElementById('support-modal');
            modal.classList.toggle('hidden');
            modal.classList.toggle('flex');
        }

        function sendSupportMessage() {
            const input = document.getElementById('support-input');
            const text = input.value.trim();
            if(!text) return;

            const chat = document.getElementById('support-messages');
            chat.innerHTML += `<div class="self-end bg-[#e0f7e0] text-black p-2 rounded-lg text-sm max-w-[85%] shadow-sm rounded-tr-none">${text}</div>`;
            input.value = "";
            chat.scrollTop = chat.scrollHeight;

            // R√©ponse auto de "Majda"
            setTimeout(() => {
                chat.innerHTML += `<div class="self-start bg-white text-black p-2 rounded-lg text-sm max-w-[85%] shadow-sm rounded-tl-none">Un agent du support a bien re√ßu votre message. Nous traitons votre demande.</div>`;
                chat.scrollTop = chat.scrollHeight;
            }, 1000);
        }

    </script>
</body>
</html>

